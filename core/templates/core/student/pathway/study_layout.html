<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ subject.name }} - Study | EduTech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%); }
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .sidebar-item:hover { background: rgba(16, 185, 129, 0.1); }
        .sidebar-item.active { background: rgba(16, 185, 129, 0.15); border-left: 3px solid #10b981; }
        .tab-active { border-bottom: 3px solid #10b981; color: #10b981; font-weight: 600; }
        .content-area { min-height: calc(100vh - 180px); }
        .touch-manipulation { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        @media (max-width: 1023px) {
            .sidebar-overlay { background: rgba(0,0,0,0.5); }
            .mobile-sidebar { position: fixed; top: 0; left: 0; bottom: 0; z-index: 50; }
        }
        @media (max-width: 640px) {
            .content-area { min-height: calc(100vh - 160px); padding: 0.75rem; }
        }
    </style>
</head>
<body class="h-full bg-gray-50" x-data="studyApp()">
    {% csrf_token %}
    <div class="min-h-full flex flex-col">
        <!-- Top Header -->
        <header class="bg-white card-shadow sticky top-0 z-50">
            <div class="px-4 lg:px-6">
                <div class="flex items-center justify-between h-14">
                    <div class="flex items-center gap-2">
                        <button @click="sidebarOpen = !sidebarOpen" 
                                class="lg:hidden flex items-center justify-center w-10 h-10 rounded-lg bg-emerald-50 text-emerald-600 hover:bg-emerald-100 active:bg-emerald-200 transition-colors touch-manipulation"
                                aria-label="Toggle menu">
                            <i class="fas fa-bars text-lg"></i>
                        </button>
                        <a href="{% url 'student_dashboard' %}" class="flex items-center gap-2 text-gray-600 hover:text-emerald-600 p-2">
                            <i class="fas fa-arrow-left"></i>
                            <span class="hidden sm:inline">Dashboard</span>
                        </a>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg gradient-bg flex items-center justify-center">
                            <i class="fas fa-graduation-cap text-white text-sm"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-900 hidden sm:block">EduTech</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Subject Bar with Progress -->
        <div class="bg-white border-b px-4 lg:px-6 py-3">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                <div>
                    <h1 class="text-lg sm:text-xl font-bold text-gray-900">{{ subject.name }}</h1>
                    <p class="text-xs sm:text-sm text-gray-500">{{ exam_board.abbreviation }} • <span x-text="currentTopicName || 'Select a topic'"></span></p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                        <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div id="subject-progress-bar" class="h-full bg-gradient-to-r from-emerald-500 to-blue-500 transition-all duration-500" :style="`width: ${subjectProgress}%`"></div>
                        </div>
                        <span class="text-xs font-medium text-gray-600" x-text="`${subjectProgress}%`"></span>
                    </div>
                    <span class="px-2 py-1 bg-emerald-50 text-emerald-700 rounded-full text-xs">
                        <span x-text="completedTopics"></span>/<span x-text="totalTopics"></span> Topics
                    </span>
                </div>
            </div>
        </div>

        <div class="flex flex-1 relative">
            <!-- Mobile Sidebar Overlay -->
            <div x-show="sidebarOpen" @click="sidebarOpen = false" class="fixed inset-0 sidebar-overlay z-40 lg:hidden" x-transition:enter="transition-opacity ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition-opacity ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"></div>

            <!-- Left Sidebar - Topics Tree -->
            <aside :class="[sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0', sidebarCollapsed ? 'lg:w-16' : 'lg:w-72']" class="fixed lg:static left-0 z-50 lg:z-auto w-72 bg-white border-r transform transition-all duration-300 ease-in-out overflow-y-auto top-0 h-full lg:h-auto" style="height: 100vh;">
                <!-- Mobile Header with Close Button -->
                <div class="lg:hidden flex items-center justify-between p-4 border-b bg-emerald-50">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg gradient-bg flex items-center justify-center">
                            <i class="fas fa-book-open text-white text-sm"></i>
                        </div>
                        <span class="font-bold text-gray-900">Topics</span>
                    </div>
                    <button @click="sidebarOpen = false" class="flex items-center justify-center w-10 h-10 rounded-lg bg-white text-gray-600 hover:text-red-500 transition-colors touch-manipulation shadow-sm">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
                
                <div class="p-4">
                    <div class="hidden lg:flex items-center justify-between mb-4">
                        <h2 x-show="!sidebarCollapsed" class="text-sm font-bold text-gray-900 uppercase tracking-wide">Topics</h2>
                        <button @click="sidebarCollapsed = !sidebarCollapsed" class="flex items-center justify-center w-8 h-8 rounded-lg hover:bg-gray-100 text-gray-500 hover:text-emerald-600 transition-colors" title="Toggle Sidebar">
                            <i class="fas" :class="sidebarCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'"></i>
                        </button>
                    </div>
                    <div class="space-y-1" x-show="!sidebarCollapsed">
                        {% for item in topics_with_data %}
                            <div x-data="{ expanded: false }" class="mb-1">
                                <button @click="expanded = !expanded; selectTopic({{ item.topic.id }}, '{{ item.topic.name|escapejs }}')" 
                                        :class="{ 'active': selectedTopicId === {{ item.topic.id }} }"
                                        class="w-full flex items-center justify-between p-3 rounded-lg sidebar-item transition-colors text-left">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold relative" 
                                             :class="topicProgress[{{ item.topic.id }}]?.is_completed ? 'bg-emerald-500 text-white' : (selectedTopicId === {{ item.topic.id }} ? 'bg-emerald-500 text-white' : 'bg-gray-100 text-gray-600')">
                                            <span x-show="!topicProgress[{{ item.topic.id }}]?.is_completed">{{ forloop.counter }}</span>
                                            <i x-show="topicProgress[{{ item.topic.id }}]?.is_completed" class="fas fa-check"></i>
                                        </div>
                                        <span class="font-medium text-gray-800 text-sm">{{ item.topic.name }}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span x-show="topicProgress[{{ item.topic.id }}]?.completion_percentage > 0 && !topicProgress[{{ item.topic.id }}]?.is_completed" 
                                              class="text-xs text-emerald-600 font-medium" 
                                              x-text="`${topicProgress[{{ item.topic.id }}]?.completion_percentage || 0}%`"></span>
                                        {% if item.subtopics %}
                                            <i class="fas fa-chevron-down text-xs text-gray-400 transition-transform" :class="{ 'rotate-180': expanded }"></i>
                                        {% endif %}
                                    </div>
                                </button>
                                {% if item.subtopics %}
                                    <div x-show="expanded" x-collapse class="ml-4 mt-1 border-l-2 border-gray-200 pl-3 space-y-1">
                                        {% for subtopic in item.subtopics %}
                                            <button @click="selectSubtopic({{ subtopic.id }}, '{{ subtopic.name|escapejs }}', {{ item.topic.id }})" 
                                                    :class="{ 'text-emerald-600 font-medium': selectedSubtopicId === {{ subtopic.id }} }"
                                                    class="w-full text-left p-2 text-sm text-gray-600 hover:text-emerald-600 rounded-lg hover:bg-emerald-50 transition-colors">
                                                <i class="fas fa-circle text-[6px] mr-2" :class="selectedSubtopicId === {{ subtopic.id }} ? 'text-emerald-500' : 'text-gray-300'"></i>
                                                {{ subtopic.name }}
                                            </button>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% empty %}
                            <p class="text-gray-500 text-sm p-4">No topics available yet.</p>
                        {% endfor %}
                    </div>
                    
                    <div class="space-y-2" x-show="sidebarCollapsed">
                        {% for item in topics_with_data %}
                            <button @click="selectTopic({{ item.topic.id }}, '{{ item.topic.name|escapejs }}'); sidebarCollapsed = false" 
                                    :class="{ 'bg-emerald-500 text-white': selectedTopicId === {{ item.topic.id }}, 'bg-gray-100 text-gray-600 hover:bg-emerald-100': selectedTopicId !== {{ item.topic.id }} }"
                                    class="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold transition-colors mx-auto" 
                                    title="{{ item.topic.name }}">
                                {{ forloop.counter }}
                            </button>
                        {% endfor %}
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 flex flex-col min-w-0">
                <!-- Tabs -->
                <div class="bg-white border-b sticky top-0 z-30">
                    <div class="flex overflow-x-auto scrollbar-hide">
                        <button @click="activeTab = 'notes'" :class="activeTab === 'notes' ? 'tab-active' : 'text-gray-600'" class="flex-shrink-0 px-4 sm:px-6 py-3 text-sm font-medium border-b-3 border-transparent hover:text-emerald-600 transition-colors">
                            <i class="fas fa-sticky-note mr-2"></i>Notes
                        </button>
                        <button @click="activeTab = 'video'" :class="activeTab === 'video' ? 'tab-active' : 'text-gray-600'" class="flex-shrink-0 px-4 sm:px-6 py-3 text-sm font-medium border-b-3 border-transparent hover:text-emerald-600 transition-colors">
                            <i class="fas fa-play-circle mr-2"></i>Video
                        </button>
                        <button @click="activeTab = 'quiz'" :class="activeTab === 'quiz' ? 'tab-active' : 'text-gray-600'" class="flex-shrink-0 px-4 sm:px-6 py-3 text-sm font-medium border-b-3 border-transparent hover:text-emerald-600 transition-colors">
                            <i class="fas fa-brain mr-2"></i>Quiz
                        </button>
                        <button @click="activeTab = 'test'" :class="activeTab === 'test' ? 'tab-active' : 'text-gray-600'" class="flex-shrink-0 px-4 sm:px-6 py-3 text-sm font-medium border-b-3 border-transparent hover:text-emerald-600 transition-colors">
                            <i class="fas fa-file-alt mr-2"></i>Test
                        </button>
                    </div>
                </div>

                <!-- Content Area -->
                <div class="flex-1 p-4 sm:p-6 content-area">
                    <!-- No Topic Selected -->
                    <template x-if="!selectedTopicId">
                        <div class="flex flex-col items-center justify-center h-full text-center py-12">
                            <div class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mb-4">
                                <i class="fas fa-hand-pointer text-gray-400 text-3xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">Select a Topic</h3>
                            <p class="text-gray-600 max-w-md">Choose a topic from the sidebar to start learning. Click on a topic to see its content.</p>
                        </div>
                    </template>

                    <!-- Topic Selected - Show Content -->
                    <template x-if="selectedTopicId">
                        <div>
                            <!-- Topic Progress Banner -->
                            <div class="mb-4 bg-gradient-to-r from-emerald-50 to-blue-50 border border-emerald-200 rounded-xl p-4">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full flex items-center justify-center"
                                             :class="topicProgress[selectedTopicId]?.is_completed ? 'bg-emerald-500 text-white' : 'bg-white border-2 border-emerald-300 text-emerald-600'">
                                            <i class="fas" :class="topicProgress[selectedTopicId]?.is_completed ? 'fa-check' : 'fa-book-open'"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-900" x-text="currentTopicName"></p>
                                            <p class="text-sm text-gray-600">
                                                <span x-show="topicProgress[selectedTopicId]?.is_completed" class="text-emerald-600 font-medium">
                                                    <i class="fas fa-check-circle mr-1"></i>Completed
                                                </span>
                                                <span x-show="!topicProgress[selectedTopicId]?.is_completed">
                                                    Progress: <span x-text="`${topicProgress[selectedTopicId]?.completion_percentage || 0}%`"></span>
                                                </span>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button x-show="!topicProgress[selectedTopicId]?.is_completed"
                                                @click="markTopicComplete(selectedTopicId, 'complete')"
                                                class="px-4 py-2 bg-emerald-500 text-white text-sm font-semibold rounded-lg hover:bg-emerald-600 transition-colors">
                                            <i class="fas fa-check mr-2"></i>Mark Complete
                                        </button>
                                        <button x-show="topicProgress[selectedTopicId]?.is_completed"
                                                @click="markTopicComplete(selectedTopicId, 'uncomplete')"
                                                class="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                                            <i class="fas fa-undo mr-2"></i>Mark Incomplete
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Notes Tab -->
                            <div x-show="activeTab === 'notes'">
                                <div class="bg-white rounded-2xl card-shadow p-6" id="notes-content">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="text-lg font-bold text-gray-900">
                                            <i class="fas fa-sticky-note text-amber-500 mr-2"></i>
                                            Study Notes
                                        </h3>
                                    </div>
                                    <div id="notes-list" class="space-y-4">
                                        <div class="text-center py-8 text-gray-500">
                                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                            <p>Loading notes...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Video Tab -->
                            <div x-show="activeTab === 'video'">
                                <div class="bg-white rounded-2xl card-shadow p-6" id="video-content">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="text-lg font-bold text-gray-900">
                                            <i class="fas fa-play-circle text-red-500 mr-2"></i>
                                            Video Lessons
                                        </h3>
                                    </div>
                                    <div id="videos-list" class="space-y-4">
                                        <div class="text-center py-8 text-gray-500">
                                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                            <p>Loading videos...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quiz Tab -->
                            <div x-show="activeTab === 'quiz'">
                                <div class="bg-white rounded-2xl card-shadow p-6" id="quiz-content">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="text-lg font-bold text-gray-900">
                                            <i class="fas fa-brain text-blue-500 mr-2"></i>
                                            Practice Quizzes
                                        </h3>
                                    </div>
                                    <div id="quizzes-list" class="space-y-4">
                                        <div class="text-center py-8 text-gray-500">
                                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                            <p>Loading quizzes...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Test Tab -->
                            <div x-show="activeTab === 'test'">
                                <div class="bg-white rounded-2xl card-shadow p-6" id="test-content">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="text-lg font-bold text-gray-900">
                                            <i class="fas fa-file-alt text-purple-500 mr-2"></i>
                                            Self-Assessment Test
                                        </h3>
                                        <button onclick="revealAllAnswers()" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors text-sm font-medium">
                                            <i class="fas fa-eye mr-1"></i> Reveal All Answers
                                        </button>
                                    </div>
                                    <p class="text-gray-600 text-sm mb-6">Answer the questions below, then reveal answers to check your work. You can also use AI to compare your answer.</p>
                                    <div id="test-questions-list" class="space-y-6">
                                        <div class="text-center py-8 text-gray-500">
                                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                            <p>Loading test questions...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </main>
        </div>
    </div>

    <script>
        function studyApp() {
            return {
                sidebarOpen: false,
                sidebarCollapsed: false,
                activeTab: 'notes',
                selectedTopicId: null,
                selectedSubtopicId: null,
                currentTopicName: '',
                contentLoaded: false,
                topicProgress: {},
                subjectProgress: 0,
                completedTopics: 0,
                totalTopics: {{ topics_with_data|length }},
                
                init() {
                    this.fetchProgress();
                    this.$watch('activeTab', () => {
                        if (this.selectedTopicId && this.contentLoaded) {
                            // Content already loaded, just switch tabs
                        }
                    });
                },
                
                fetchProgress() {
                    fetch('/student/api/subject/{{ subject.id }}/progress/')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                this.topicProgress = data.topics;
                                this.subjectProgress = data.subject_completion;
                                this.completedTopics = data.completed_topics;
                                this.totalTopics = data.total_topics;
                            }
                        })
                        .catch(err => console.log('Progress fetch error:', err));
                },
                
                markTopicComplete(topicId, action = 'complete') {
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    fetch('/student/api/topic/complete/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ topic_id: topicId, action: action })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            this.topicProgress[topicId] = {
                                ...this.topicProgress[topicId],
                                is_completed: data.is_completed,
                                completion_percentage: data.completion_percentage
                            };
                            this.subjectProgress = data.subject_completion;
                            this.completedTopics = data.completed_topics;
                        }
                    })
                    .catch(err => console.log('Mark complete error:', err));
                },
                
                selectTopic(topicId, topicName) {
                    this.selectedTopicId = topicId;
                    this.currentTopicName = topicName;
                    this.selectedSubtopicId = null;
                    this.sidebarOpen = false;
                    this.loadContent(topicId);
                },
                
                selectSubtopic(subtopicId, subtopicName, topicId) {
                    this.selectedSubtopicId = subtopicId;
                    this.selectedTopicId = topicId;
                    this.currentTopicName = subtopicName;
                    this.sidebarOpen = false;
                    this.loadContent(topicId, subtopicId);
                },
                
                loadContent(topicId, subtopicId = null) {
                    this.contentLoaded = false;
                    const subjectId = {{ subject.id }};
                    let url = `/student/subject/${subjectId}/content/${topicId}/`;
                    if (subtopicId) {
                        url += `?subtopic=${subtopicId}`;
                    }
                    
                    ['notes-list', 'videos-list', 'quizzes-list', 'test-questions-list'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>Loading...</p></div>';
                    });
                    
                    fetch(url, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        this.renderNotes(data.notes || [], data.topic_overview || '');
                        this.renderVideos(data.videos || [], data.topic_youtube_embed, data.topic_youtube_link);
                        this.renderQuizzes(data.quizzes || []);
                        this.renderFlashcards(data.flashcards || []);
                        this.renderTestQuestions(data.test_questions || []);
                        this.contentLoaded = true;
                    })
                    .catch(err => {
                        console.error('Error loading content:', err);
                        ['notes-list', 'videos-list', 'quizzes-list', 'test-questions-list'].forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.innerHTML = '<div class="text-center py-8 text-red-500"><i class="fas fa-exclamation-circle text-2xl mb-2"></i><p>Error loading content</p></div>';
                        });
                    });
                },
                
                renderNotes(notes, topicOverview = '') {
                    const container = document.getElementById('notes-list');
                    let html = '';
                    
                    if (topicOverview) {
                        html += `
                            <div class="mb-6 p-4 bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl">
                                <div class="flex items-center gap-2 mb-3">
                                    <div class="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center">
                                        <i class="fas fa-info-circle text-white"></i>
                                    </div>
                                    <h4 class="font-bold text-gray-900">Topic Overview</h4>
                                </div>
                                <div class="text-gray-700 leading-relaxed whitespace-pre-line">${topicOverview}</div>
                            </div>
                        `;
                    }
                    
                    if (notes.length === 0 && !topicOverview) {
                        container.innerHTML = `
                            <div class="text-center py-8">
                                <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-sticky-note text-gray-400 text-2xl"></i>
                                </div>
                                <p class="text-gray-600">No notes available for this topic yet.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    if (notes.length > 0) {
                        html += notes.map(note => `
                            <a href="/student/note/${note.id}/" class="block p-4 bg-gradient-to-br from-amber-50 to-orange-50 border-2 border-amber-200 rounded-xl hover:shadow-lg transition-all mb-3">
                                <h4 class="font-bold text-gray-900 mb-1">${note.title}</h4>
                                <p class="text-sm text-gray-600">${note.description || 'Study notes'}</p>
                                <div class="flex items-center gap-4 mt-2 text-xs text-gray-500">
                                    ${note.has_full ? '<span><i class="fas fa-file-pdf mr-1"></i>Full Notes</span>' : ''}
                                    ${note.has_summary ? '<span><i class="fas fa-compress-alt mr-1"></i>Summary</span>' : ''}
                                </div>
                            </a>
                        `).join('');
                    }
                    
                    container.innerHTML = html || `
                        <div class="text-center py-8">
                            <p class="text-gray-600">No additional notes available.</p>
                        </div>
                    `;
                },
                
                renderVideos(videos, topicYoutubeEmbed = null, topicYoutubeLink = '') {
                    const container = document.getElementById('videos-list');
                    let html = '';
                    
                    if (topicYoutubeEmbed) {
                        html += `
                            <div class="mb-6">
                                <div class="flex items-center gap-2 mb-3">
                                    <div class="w-8 h-8 rounded-lg bg-red-500 flex items-center justify-center">
                                        <i class="fab fa-youtube text-white"></i>
                                    </div>
                                    <h4 class="font-bold text-gray-900">Topic Introduction Video</h4>
                                </div>
                                <div class="relative w-full rounded-xl overflow-hidden shadow-lg" style="padding-bottom: 56.25%;">
                                    <iframe 
                                        src="${topicYoutubeEmbed}" 
                                        class="absolute top-0 left-0 w-full h-full"
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen>
                                    </iframe>
                                </div>
                            </div>
                        `;
                    } else if (topicYoutubeLink) {
                        html += `
                            <div class="mb-6">
                                <div class="flex items-center gap-2 mb-3">
                                    <div class="w-8 h-8 rounded-lg bg-red-500 flex items-center justify-center">
                                        <i class="fab fa-youtube text-white"></i>
                                    </div>
                                    <h4 class="font-bold text-gray-900">Topic Introduction Video</h4>
                                </div>
                                <a href="${topicYoutubeLink}" target="_blank" rel="noopener noreferrer" class="block p-4 bg-gradient-to-br from-red-50 to-pink-50 border-2 border-red-200 rounded-xl hover:shadow-lg transition-all">
                                    <div class="flex items-center gap-4">
                                        <div class="w-16 h-16 bg-red-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <i class="fab fa-youtube text-white text-2xl"></i>
                                        </div>
                                        <div class="flex-1">
                                            <h4 class="font-bold text-gray-900 mb-1">Watch on YouTube</h4>
                                            <p class="text-sm text-gray-600">Click to open the topic introduction video in a new tab</p>
                                        </div>
                                        <i class="fas fa-external-link-alt text-gray-400"></i>
                                    </div>
                                </a>
                            </div>
                        `;
                    }
                    
                    if (videos.length === 0 && !topicYoutubeEmbed && !topicYoutubeLink) {
                        container.innerHTML = `
                            <div class="text-center py-8">
                                <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-video text-gray-400 text-2xl"></i>
                                </div>
                                <p class="text-gray-600">No videos available for this topic yet.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    if (videos.length > 0) {
                        html += `<h4 class="font-bold text-gray-900 mb-3 ${topicYoutubeEmbed ? 'mt-6' : ''}">Additional Video Lessons</h4>`;
                        html += videos.map(video => `
                            <a href="/student/videos/${video.id}/" class="block p-4 bg-gradient-to-br from-red-50 to-pink-50 border-2 border-red-200 rounded-xl hover:shadow-lg transition-all mb-3">
                                <div class="flex items-start gap-4">
                                    <div class="w-24 h-16 bg-gray-900 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <i class="fas fa-play text-white text-xl"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-bold text-gray-900 mb-1">${video.title}</h4>
                                        <p class="text-sm text-gray-600">${video.duration || ''}</p>
                                    </div>
                                </div>
                            </a>
                        `).join('');
                    }
                    
                    container.innerHTML = html;
                },
                
                renderQuizzes(quizzes) {
                    const container = document.getElementById('quizzes-list');
                    if (quizzes.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-8">
                                <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-brain text-gray-400 text-2xl"></i>
                                </div>
                                <p class="text-gray-600">No quizzes available for this topic yet.</p>
                            </div>
                        `;
                        return;
                    }
                    container.innerHTML = quizzes.map(quiz => `
                        <a href="/student/quiz/${quiz.id}/start/" class="block p-4 bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl hover:shadow-lg transition-all">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-bold text-gray-900 mb-1">${quiz.title}</h4>
                                    <p class="text-sm text-gray-600">${quiz.questions_count} questions • ${quiz.difficulty}</p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-bold ${
                                    quiz.difficulty === 'easy' ? 'bg-green-100 text-green-700' :
                                    quiz.difficulty === 'medium' ? 'bg-amber-100 text-amber-700' :
                                    'bg-red-100 text-red-700'
                                }">
                                    ${quiz.difficulty}
                                </span>
                            </div>
                        </a>
                    `).join('');
                },
                
                renderFlashcards(flashcards) {
                    const container = document.getElementById('flashcards-list');
                    if (!container) return;
                    if (flashcards.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-8">
                                <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-layer-group text-gray-400 text-2xl"></i>
                                </div>
                                <p class="text-gray-600">No flashcards available for this topic yet.</p>
                            </div>
                        `;
                        return;
                    }
                    container.innerHTML = `
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            ${flashcards.slice(0, 6).map(card => `
                                <div class="p-4 bg-gradient-to-br from-purple-50 to-violet-50 border-2 border-purple-200 rounded-xl">
                                    <p class="font-medium text-gray-900 mb-2">${card.front}</p>
                                    <p class="text-sm text-gray-600 border-t pt-2">${card.back}</p>
                                </div>
                            `).join('')}
                        </div>
                        ${flashcards.length > 6 ? `
                            <div class="text-center mt-4">
                                <a href="/student/flashcards/study/{{ subject.id }}/" class="inline-flex items-center gap-2 px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors">
                                    <i class="fas fa-layer-group"></i>
                                    Study All ${flashcards.length} Flashcards
                                </a>
                            </div>
                        ` : ''}
                    `;
                },
                
                renderTestQuestions(questions) {
                    const container = document.getElementById('test-questions-list');
                    if (!container) return;
                    if (questions.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-8">
                                <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-file-alt text-gray-400 text-2xl"></i>
                                </div>
                                <p class="text-gray-600">No test questions available for this topic yet.</p>
                                <p class="text-sm text-gray-500 mt-2">Check back later or try a different topic.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    window.testQuestionsData = questions;
                    
                    container.innerHTML = questions.map((q, idx) => `
                        <div class="p-5 bg-gradient-to-br from-gray-50 to-slate-50 border-2 border-gray-200 rounded-xl question-card" data-question-id="${q.id}">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center text-sm font-bold">${idx + 1}</span>
                                    <span class="px-2 py-1 rounded text-xs font-medium ${
                                        q.difficulty === 'easy' ? 'bg-green-100 text-green-700' :
                                        q.difficulty === 'medium' ? 'bg-amber-100 text-amber-700' :
                                        'bg-red-100 text-red-700'
                                    }">${q.difficulty}</span>
                                    <span class="text-xs text-gray-500">${q.max_marks} mark${q.max_marks > 1 ? 's' : ''}</span>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <p class="text-gray-900 font-medium">${q.question_text}</p>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Your Answer:</label>
                                <textarea id="answer-${q.id}" rows="4" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-colors resize-none" placeholder="Type your answer here..."></textarea>
                            </div>
                            
                            <div class="flex flex-wrap gap-2 mb-4">
                                <button onclick="revealAnswer(${q.id})" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors text-sm font-medium">
                                    <i class="fas fa-eye mr-1"></i> Reveal Answer
                                </button>
                                <button onclick="checkAnswerWithAI(${q.id})" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm font-medium">
                                    <i class="fas fa-robot mr-1"></i> Check with AI
                                </button>
                            </div>
                            
                            <div id="model-answer-${q.id}" class="hidden mt-4 p-4 bg-emerald-50 border-2 border-emerald-200 rounded-xl">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-check-circle text-emerald-600"></i>
                                    <span class="font-bold text-emerald-800">Model Answer:</span>
                                </div>
                                <p class="text-gray-800">${q.model_answer || 'No model answer provided'}</p>
                                ${q.marking_guide ? `
                                    <div class="mt-3 pt-3 border-t border-emerald-200">
                                        <span class="text-sm font-medium text-emerald-700">Marking Guide:</span>
                                        <p class="text-sm text-gray-700 mt-1">${q.marking_guide}</p>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div id="ai-feedback-${q.id}" class="hidden mt-4 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-robot text-blue-600"></i>
                                    <span class="font-bold text-blue-800">AI Feedback:</span>
                                </div>
                                <div id="ai-feedback-content-${q.id}" class="text-gray-800"></div>
                            </div>
                            
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <span class="text-sm text-gray-600 mr-3">Self-Mark:</span>
                                <button onclick="selfMark(${q.id}, 'correct')" class="px-3 py-1.5 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm font-medium mr-2">
                                    <i class="fas fa-check mr-1"></i> Correct
                                </button>
                                <button onclick="selfMark(${q.id}, 'partial')" class="px-3 py-1.5 bg-amber-100 text-amber-700 rounded-lg hover:bg-amber-200 transition-colors text-sm font-medium mr-2">
                                    <i class="fas fa-minus mr-1"></i> Partial
                                </button>
                                <button onclick="selfMark(${q.id}, 'incorrect')" class="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm font-medium">
                                    <i class="fas fa-times mr-1"></i> Incorrect
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }
        
        function revealAnswer(questionId) {
            const answerEl = document.getElementById(`model-answer-${questionId}`);
            if (answerEl) {
                answerEl.classList.toggle('hidden');
            }
        }
        
        function revealAllAnswers() {
            document.querySelectorAll('[id^="model-answer-"]').forEach(el => {
                el.classList.remove('hidden');
            });
        }
        
        function selfMark(questionId, result) {
            const card = document.querySelector(`[data-question-id="${questionId}"]`);
            if (!card) return;
            
            card.classList.remove('border-green-400', 'border-amber-400', 'border-red-400');
            if (result === 'correct') {
                card.classList.add('border-green-400');
            } else if (result === 'partial') {
                card.classList.add('border-amber-400');
            } else {
                card.classList.add('border-red-400');
            }
        }
        
        function checkAnswerWithAI(questionId) {
            const studentAnswer = document.getElementById(`answer-${questionId}`).value.trim();
            if (!studentAnswer) {
                alert('Please write your answer first before checking with AI.');
                return;
            }
            
            const question = window.testQuestionsData.find(q => q.id === questionId);
            if (!question) return;
            
            const feedbackEl = document.getElementById(`ai-feedback-${questionId}`);
            const feedbackContent = document.getElementById(`ai-feedback-content-${questionId}`);
            
            feedbackEl.classList.remove('hidden');
            feedbackContent.innerHTML = '<div class="flex items-center gap-2"><i class="fas fa-spinner fa-spin"></i> AI is analyzing your answer...</div>';
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            fetch('/student/api/check-answer/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    question_id: questionId,
                    student_answer: studentAnswer,
                    model_answer: question.model_answer,
                    question_text: question.question_text,
                    max_marks: question.max_marks
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    feedbackContent.innerHTML = `
                        <div class="mb-2">
                            <span class="font-bold text-lg ${
                                data.score >= 80 ? 'text-green-600' :
                                data.score >= 50 ? 'text-amber-600' :
                                'text-red-600'
                            }">Score: ${data.score}%</span>
                        </div>
                        <p>${data.feedback}</p>
                    `;
                } else {
                    feedbackContent.innerHTML = `<p class="text-red-600">Error: ${data.error || 'Could not check answer'}</p>`;
                }
            })
            .catch(err => {
                feedbackContent.innerHTML = `<p class="text-red-600">Error connecting to AI service. Please try again.</p>`;
            });
        }
    </script>
</body>
</html>
