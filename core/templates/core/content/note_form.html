{% extends 'core/content/base.html' %}
{% load static %}

{% block title %}{% if note %}Edit{% else %}Create{% endif %} Note - Content Portal{% endblock %}

{% block content %}
<div class="mb-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="heading-primary">{% if note %}Edit{% else %}Create{% endif %} Study Note</h1>
            <p class="mt-2 text-base text-gray-600 font-medium">Create rich notes with formatting, images, and math equations</p>
        </div>
        <a href="{% url 'manage_notes' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Notes
        </a>
    </div>
</div>

<!-- Editor Tips -->
<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
    <h3 class="text-sm font-semibold text-blue-800 mb-2">
        <i class="fas fa-lightbulb mr-2"></i>Rich Text Editor Features
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs text-blue-700">
        <div>
            <strong>Formatting:</strong> Bold, italic, headings, bullet lists, numbered lists
        </div>
        <div>
            <strong>Media:</strong> Insert images via URL or upload
        </div>
        <div>
            <strong>Math:</strong> Use LaTeX syntax like <code class="bg-blue-100 px-1 rounded">$$x^2 + y^2 = z^2$$</code>
        </div>
    </div>
</div>

<div class="stat-card max-w-5xl" x-data="noteFormData()">
    <form method="POST" enctype="multipart/form-data" @submit="prepareSubmit()">
        {% csrf_token %}
        
        <!-- Basic Information -->
        <div class="mb-8">
            <h2 class="text-lg font-bold text-gray-900 mb-4 border-b pb-2">
                <i class="fas fa-info-circle mr-2 text-orange-500"></i>Basic Information
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Title *</label>
                    <input type="text" name="title" required value="{% if note %}{{ note.title }}{% elif form_data %}{{ form_data.title }}{% endif %}" placeholder="e.g., Algebra Basics - Complete Guide" class="w-full px-4 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                </div>
                
                {% if not note %}
                <div class="md:col-span-2 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-blue-700">
                        <i class="fas fa-info-circle mr-2"></i>
                        Select Exam Board, Subject, Grade, Topic, then Subtopic to organize your note. Notes are linked at the subtopic level for granular content organization.
                    </p>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Exam Board *</label>
                    <select x-model="examBoard" @change="onExamBoardChange()" class="w-full px-4 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        <option value="">Select Exam Board</option>
                        {% for board in exam_boards %}
                        <option value="{{ board.id }}">{{ board.name }} ({{ board.abbreviation }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Subject *</label>
                    <select x-model="subject" @change="onSubjectChange()" :disabled="!examBoard || loadingSubjects" class="w-full px-4 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-transparent disabled:bg-gray-100">
                        <option value="">Select Subject</option>
                        <template x-for="subj in subjects" :key="subj.id">
                            <option :value="subj.id" x-text="subj.name"></option>
                        </template>
                    </select>
                    <p x-show="loadingSubjects" class="mt-1 text-xs text-gray-500"><i class="fas fa-spinner fa-spin mr-1"></i>Loading subjects...</p>
                    <p x-show="!loadingSubjects && examBoard && subjects.length === 0" class="mt-1 text-xs text-amber-600">No subjects found for this exam board</p>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Grade *</label>
                    <select x-model="grade" @change="onGradeChange()" :disabled="!subject || loadingGrades" class="w-full px-4 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-transparent disabled:bg-gray-100">
                        <option value="">Select Grade</option>
                        <template x-for="g in grades" :key="g.id">
                            <option :value="g.id" x-text="g.name"></option>
                        </template>
                    </select>
                    <p x-show="loadingGrades" class="mt-1 text-xs text-gray-500"><i class="fas fa-spinner fa-spin mr-1"></i>Loading grades...</p>
                    <p x-show="!loadingGrades && subject && grades.length === 0" class="mt-1 text-xs text-amber-600">No grades found with topics for this subject</p>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Topic *</label>
                    <select x-model="topic" @change="onTopicChange()" :disabled="!grade || loadingTopics" class="w-full px-4 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-transparent disabled:bg-gray-100">
                        <option value="">Select Topic</option>
                        <template x-for="t in topics" :key="t.id">
                            <option :value="t.id" x-text="t.name"></option>
                        </template>
                    </select>
                    <p x-show="loadingTopics" class="mt-1 text-xs text-gray-500"><i class="fas fa-spinner fa-spin mr-1"></i>Loading topics...</p>
                    <p x-show="!loadingTopics && grade && topics.length === 0" class="mt-1 text-xs text-amber-600">No topics found for this grade</p>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Subtopic *</label>
                    <select name="subtopic" x-model="subtopic" :disabled="!topic || loadingSubtopics" required class="w-full px-4 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-transparent disabled:bg-gray-100">
                        <option value="">Select Subtopic</option>
                        <template x-for="st in subtopics" :key="st.id">
                            <option :value="st.id" x-text="st.name"></option>
                        </template>
                    </select>
                    <p x-show="loadingSubtopics" class="mt-1 text-xs text-gray-500"><i class="fas fa-spinner fa-spin mr-1"></i>Loading subtopics...</p>
                    <p x-show="!loadingSubtopics && topic && subtopics.length === 0" class="mt-1 text-xs text-amber-600">No subtopics found for this topic. Please create subtopics first.</p>
                </div>
                {% else %}
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Location</label>
                    <div class="px-4 py-2.5 bg-gray-100 border border-gray-300 rounded-md text-gray-700">
                        {{ note.exam_board.abbreviation }} - {{ note.subject.name }} - 
                        Grade {{ note.grade.number }} - 
                        {% if note.subtopic %}{{ note.topic.name }} â†’ {{ note.subtopic.name }}{% else %}{{ note.topic.name|default:note.topic_text }}{% endif %}
                    </div>
                    {% if note.subtopic %}
                    <input type="hidden" name="subtopic" value="{{ note.subtopic.id }}">
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Full Version Content -->
        <div class="mb-8">
            <h2 class="text-lg font-bold text-gray-900 mb-4 border-b pb-2">
                <i class="fas fa-file-alt mr-2 text-orange-500"></i>Full Version (Detailed Notes)
            </h2>
            
            <div class="space-y-4">
                <!-- Tab Selection -->
                <div class="flex gap-2 border-b">
                    <button type="button" @click="fullVersionTab = 'editor'" 
                            :class="fullVersionTab === 'editor' ? 'border-orange-500 text-orange-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="px-4 py-2 text-sm font-medium border-b-2 -mb-px transition">
                        <i class="fas fa-edit mr-2"></i>Rich Text Editor
                    </button>
                    <button type="button" @click="fullVersionTab = 'upload'" 
                            :class="fullVersionTab === 'upload' ? 'border-orange-500 text-orange-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="px-4 py-2 text-sm font-medium border-b-2 -mb-px transition">
                        <i class="fas fa-upload mr-2"></i>Upload File
                    </button>
                </div>
                
                <!-- Editor Tab -->
                <div x-show="fullVersionTab === 'editor'" x-cloak>
                    <div id="full-version-editor" class="min-h-[400px] border border-gray-300 rounded-md"></div>
                    <input type="hidden" name="full_version_text" id="full_version_text_input">
                    <p class="mt-2 text-xs text-gray-500">
                        <i class="fas fa-info-circle mr-1"></i>
                        Use the toolbar for formatting. For math equations, type LaTeX between $$ symbols (e.g., $$E = mc^2$$)
                    </p>
                </div>
                
                <!-- Upload Tab -->
                <div x-show="fullVersionTab === 'upload'" x-cloak>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <input type="file" name="full_version" accept=".pdf,.doc,.docx" class="hidden" id="full-version-file" @change="handleFullVersionFile($event)">
                        <label for="full-version-file" class="cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600">Click to upload or drag and drop</p>
                            <p class="text-xs text-gray-400 mt-1">PDF, DOC, DOCX (Max 10MB)</p>
                        </label>
                        <p x-show="fullVersionFileName" class="mt-4 text-sm text-green-600">
                            <i class="fas fa-check-circle mr-1"></i>
                            <span x-text="fullVersionFileName"></span>
                        </p>
                    </div>
                    {% if note.full_version %}
                    <p class="mt-2 text-sm text-gray-600">
                        <i class="fas fa-file mr-1"></i>Current file: <a href="{{ note.full_version.url }}" target="_blank" class="text-orange-600 hover:underline">{{ note.full_version.name|slice:"-30:" }}</a>
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Summary Version Content -->
        <div class="mb-8">
            <h2 class="text-lg font-bold text-gray-900 mb-4 border-b pb-2">
                <i class="fas fa-file-lines mr-2 text-orange-500"></i>Summary Version (Optional)
            </h2>
            
            <div class="space-y-4">
                <!-- Tab Selection -->
                <div class="flex gap-2 border-b">
                    <button type="button" @click="summaryVersionTab = 'editor'" 
                            :class="summaryVersionTab === 'editor' ? 'border-orange-500 text-orange-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="px-4 py-2 text-sm font-medium border-b-2 -mb-px transition">
                        <i class="fas fa-edit mr-2"></i>Rich Text Editor
                    </button>
                    <button type="button" @click="summaryVersionTab = 'upload'" 
                            :class="summaryVersionTab === 'upload' ? 'border-orange-500 text-orange-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="px-4 py-2 text-sm font-medium border-b-2 -mb-px transition">
                        <i class="fas fa-upload mr-2"></i>Upload File
                    </button>
                </div>
                
                <!-- Editor Tab -->
                <div x-show="summaryVersionTab === 'editor'" x-cloak>
                    <div id="summary-version-editor" class="min-h-[250px] border border-gray-300 rounded-md"></div>
                    <input type="hidden" name="summary_version_text" id="summary_version_text_input">
                    <p class="mt-2 text-xs text-gray-500">
                        <i class="fas fa-info-circle mr-1"></i>
                        A condensed version for quick review
                    </p>
                </div>
                
                <!-- Upload Tab -->
                <div x-show="summaryVersionTab === 'upload'" x-cloak>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <input type="file" name="summary_version" accept=".pdf,.doc,.docx" class="hidden" id="summary-version-file" @change="handleSummaryVersionFile($event)">
                        <label for="summary-version-file" class="cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600">Click to upload or drag and drop</p>
                            <p class="text-xs text-gray-400 mt-1">PDF, DOC, DOCX (Max 10MB)</p>
                        </label>
                        <p x-show="summaryVersionFileName" class="mt-4 text-sm text-green-600">
                            <i class="fas fa-check-circle mr-1"></i>
                            <span x-text="summaryVersionFileName"></span>
                        </p>
                    </div>
                    {% if note.summary_version %}
                    <p class="mt-2 text-sm text-gray-600">
                        <i class="fas fa-file mr-1"></i>Current file: <a href="{{ note.summary_version.url }}" target="_blank" class="text-orange-600 hover:underline">{{ note.summary_version.name|slice:"-30:" }}</a>
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Submit -->
        <div class="flex items-center justify-end gap-4 pt-6 border-t">
            <a href="{% url 'manage_notes' %}" class="px-6 py-2.5 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition">
                Cancel
            </a>
            <button type="submit" class="px-6 py-2.5 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-md shadow-md hover:shadow-lg transition font-semibold">
                <i class="fas fa-save mr-2"></i>
                {% if note %}Update{% else %}Create{% endif %} Note
            </button>
        </div>
    </form>
</div>

<!-- CKEditor 5 CDN -->
<script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
<style>
    .ck-editor__editable {
        min-height: 300px;
    }
    #summary-version-editor .ck-editor__editable {
        min-height: 200px;
    }
</style>

<script>
function noteFormData() {
    return {
        fullVersionTab: 'editor',
        summaryVersionTab: 'editor',
        fullVersionFileName: '',
        summaryVersionFileName: '',
        fullVersionEditor: null,
        summaryVersionEditor: null,
        
        examBoard: '',
        subject: '',
        grade: '',
        topic: '',
        subtopic: '',
        
        subjects: [],
        grades: [],
        topics: [],
        subtopics: [],
        
        loadingSubjects: false,
        loadingGrades: false,
        loadingTopics: false,
        loadingSubtopics: false,
        
        init() {
            this.$nextTick(() => {
                this.initEditors();
            });
        },
        
        initEditors() {
            const fullEditorEl = document.querySelector('#full-version-editor');
            const summaryEditorEl = document.querySelector('#summary-version-editor');
            
            if (fullEditorEl) {
                ClassicEditor.create(fullEditorEl, {
                    toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', '|', 'blockQuote', 'insertTable', 'undo', 'redo']
                }).then(editor => {
                    this.fullVersionEditor = editor;
                    {% if note.full_version_text %}
                    editor.setData(`{{ note.full_version_text|escapejs }}`);
                    {% endif %}
                }).catch(error => console.error('Full editor error:', error));
            }
            
            if (summaryEditorEl) {
                ClassicEditor.create(summaryEditorEl, {
                    toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', '|', 'undo', 'redo']
                }).then(editor => {
                    this.summaryVersionEditor = editor;
                    {% if note.summary_version_text %}
                    editor.setData(`{{ note.summary_version_text|escapejs }}`);
                    {% endif %}
                }).catch(error => console.error('Summary editor error:', error));
            }
        },
        
        async onExamBoardChange() {
            this.subject = '';
            this.grade = '';
            this.topic = '';
            this.subtopic = '';
            this.subjects = [];
            this.grades = [];
            this.topics = [];
            this.subtopics = [];
            
            if (!this.examBoard) return;
            
            this.loadingSubjects = true;
            try {
                const response = await fetch(`/ajax/subjects-by-board/?exam_board_id=${this.examBoard}`);
                const data = await response.json();
                this.subjects = data.subjects || [];
            } catch (error) {
                console.error('Error loading subjects:', error);
            }
            this.loadingSubjects = false;
        },
        
        async onSubjectChange() {
            this.grade = '';
            this.topic = '';
            this.subtopic = '';
            this.grades = [];
            this.topics = [];
            this.subtopics = [];
            
            if (!this.subject || !this.examBoard) return;
            
            this.loadingGrades = true;
            try {
                const response = await fetch(`/ajax/grades-by-board-subject/?exam_board_id=${this.examBoard}&subject_id=${this.subject}`);
                const data = await response.json();
                this.grades = data.grades || [];
            } catch (error) {
                console.error('Error loading grades:', error);
            }
            this.loadingGrades = false;
        },
        
        async onGradeChange() {
            this.topic = '';
            this.subtopic = '';
            this.topics = [];
            this.subtopics = [];
            
            if (!this.grade || !this.subject || !this.examBoard) return;
            
            this.loadingTopics = true;
            try {
                const response = await fetch(`/ajax/topics-by-board-subject-grade/?exam_board_id=${this.examBoard}&subject_id=${this.subject}&grade_id=${this.grade}`);
                const data = await response.json();
                this.topics = data.topics || [];
            } catch (error) {
                console.error('Error loading topics:', error);
            }
            this.loadingTopics = false;
        },
        
        async onTopicChange() {
            this.subtopic = '';
            this.subtopics = [];
            
            if (!this.topic) return;
            
            this.loadingSubtopics = true;
            try {
                const response = await fetch(`/ajax/subtopics-by-topic/?topic_id=${this.topic}`);
                const data = await response.json();
                this.subtopics = data.subtopics || [];
            } catch (error) {
                console.error('Error loading subtopics:', error);
            }
            this.loadingSubtopics = false;
        },
        
        handleFullVersionFile(event) {
            const file = event.target.files[0];
            if (file) {
                this.fullVersionFileName = file.name;
            }
        },
        
        handleSummaryVersionFile(event) {
            const file = event.target.files[0];
            if (file) {
                this.summaryVersionFileName = file.name;
            }
        },
        
        prepareSubmit() {
            if (this.fullVersionEditor) {
                document.getElementById('full_version_text_input').value = this.fullVersionEditor.getData();
            }
            if (this.summaryVersionEditor) {
                document.getElementById('summary_version_text_input').value = this.summaryVersionEditor.getData();
            }
        }
    };
}
</script>
{% endblock %}
